<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Teacher Portal – Login / Signup</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --primary: #4f46e5;
      --primary-dark: #4338ca;
      --bg: #f3f4f6;
      --text: #111827;
      --muted: #6b7280;
      --success: #10b981;
      --danger: #ef4444;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      min-height: 100vh;
      background: linear-gradient(135deg, #eef2ff, #f5f3ff);
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, 'Helvetica Neue', Arial, 'Noto Sans', 'Apple Color Emoji', 'Segoe UI Emoji';
      color: var(--text);
    }
    .card {
      width: 100%;
      max-width: 420px;
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 20px 50px rgba(79,70,229,0.15);
      overflow: hidden;
    }
    .header {
      padding: 20px 24px;
      background: #fff;
      border-bottom: 1px solid #eef2ff;
    }
    .brand {
      font-weight: 800;
      letter-spacing: 0.2px;
      color: var(--primary);
      margin: 0;
    }
    .tabs {
      display: grid;
      grid-template-columns: 1fr 1fr;
      border-bottom: 1px solid #eef2ff;
    }
    .tab {
      text-align: center;
      padding: 14px 6px;
      cursor: pointer;
      font-weight: 600;
      color: var(--muted);
      background: #fff;
      user-select: none;
    }
    .tab.active {
      color: var(--primary);
      border-bottom: 3px solid var(--primary);
      background: #fafafa;
    }
    .content {
      padding: 20px 24px 26px;
    }
    .field {
      margin-bottom: 12px;
    }
    label {
      display: block;
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 6px;
    }
    input {
      width: 100%;
      padding: 12px 12px;
      border-radius: 10px;
      border: 1px solid #e5e7eb;
      outline: none;
      transition: border 0.2s, box-shadow 0.2s;
      font-size: 15px;
    }
    input:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 4px rgba(79,70,229,0.12);
    }
    .actions {
      margin-top: 14px;
    }
    button {
      width: 100%;
      padding: 12px 14px;
      border: none;
      border-radius: 10px;
      background: var(--primary);
      color: #fff;
      font-weight: 700;
      cursor: pointer;
      transition: background 0.2s, transform 0.02s;
    }
    button:hover { background: var(--primary-dark); }
    button:active { transform: translateY(1px); }
    button[disabled] {
      background: #c7d2fe;
      cursor: not-allowed;
    }
    .row {
      display: flex; gap: 10px;
    }
    .row > div { flex: 1; }
    .muted {
      color: var(--muted);
      font-size: 13px;
      text-align: center;
      margin-top: 12px;
    }
    .link {
      color: var(--primary);
      font-weight: 600;
      text-decoration: none;
      cursor: pointer;
    }
    .error {
      background: #fef2f2; color: #991b1b; border: 1px solid #fecaca;
      padding: 10px 12px; border-radius: 10px; font-size: 13px; margin-bottom: 12px;
      display: none;
    }
    .success {
      background: #ecfdf5; color: #065f46; border: 1px solid #a7f3d0;
      padding: 10px 12px; border-radius: 10px; font-size: 13px; margin-bottom: 12px;
      display: none;
    }
  </style>
</head>
<body>
  <div class="card">
    <div class="header">
      <h1 class="brand">Transport • Teacher Portal</h1>
    </div>

    <div class="tabs">
      <div id="tab-login" class="tab active">Login</div>
      <div id="tab-signup" class="tab">Sign up</div>
    </div>

    <div class="content">

      <!-- Alerts -->
      <div id="alertError" class="error"></div>
      <div id="alertSuccess" class="success"></div>

      <!-- LOGIN -->
      <form id="loginForm">
        <div class="field">
          <label for="loginEmail">Email</label>
          <input id="loginEmail" type="email" placeholder="you@school.edu" required />
        </div>
        <div class="field">
          <label for="loginPassword">Password</label>
          <input id="loginPassword" type="password" placeholder="••••••••" required />
        </div>

        <div class="actions">
          <button id="loginBtn" type="submit">Sign in</button>
        </div>

        <p class="muted">
          <a id="forgotPassword" class="link">Forgot password?</a>
        </p>
      </form>

      <!-- SIGNUP -->
      <form id="signupForm" style="display:none">
        <div class="field">
          <label for="signupName">Full name</label>
          <input id="signupName" type="text" placeholder="Jane Teacher" required />
        </div>
        <div class="field">
          <label for="signupEmail">Email</label>
          <input id="signupEmail" type="email" placeholder="you@school.edu" required />
        </div>
        <div class="row">
          <div class="field">
            <label for="signupPassword">Password</label>
            <input id="signupPassword" type="password" placeholder="At least 6 characters" required />
          </div>
          <div class="field">
            <label for="signupPassword2">Confirm</label>
            <input id="signupPassword2" type="password" placeholder="Repeat password" required />
          </div>
        </div>

        <div class="actions">
          <button id="signupBtn" type="submit">Create account</button>
        </div>

        <p class="muted">
          By continuing, you agree to our school transport guidelines.
        </p>
      </form>

    </div>
  </div>

  <!-- Firebase logic -->
  <script type="module">
    // Firebase SDKs
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import {
      getAuth,
      onAuthStateChanged,
      signInWithEmailAndPassword,
      createUserWithEmailAndPassword,
      updateProfile,
      getIdTokenResult,
      sendPasswordResetEmail
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import {
      getFirestore,
      doc,
      getDoc,
      setDoc,
      serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    // Your Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyBzMd6bXyV5DtdJKy4jp6AdBpe3YDVIPk0",
      authDomain: "transport-35437.firebaseapp.com",
      databaseURL: "https://transport-35437-default-rtdb.firebaseio.com",
      projectId: "transport-35437",
      storageBucket: "transport-35437.firebasestorage.app",
      messagingSenderId: "495834194048",
      appId: "1:495834194048:web:a9322dee4cd1d137280665",
      measurementId: "G-3N0WXTFX40"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // UI helpers
    const tabLogin = document.getElementById('tab-login');
    const tabSignup = document.getElementById('tab-signup');
    const loginForm = document.getElementById('loginForm');
    const signupForm = document.getElementById('signupForm');
    const alertErr = document.getElementById('alertError');
    const alertOk = document.getElementById('alertSuccess');
    const showError = (msg) => { alertErr.textContent = msg; alertErr.style.display = 'block'; alertOk.style.display='none'; };
    const showSuccess = (msg) => { alertOk.textContent = msg; alertOk.style.display = 'block'; alertErr.style.display='none'; };
    const clearAlerts = () => { alertErr.style.display='none'; alertOk.style.display='none'; };

    // Tabs
    tabLogin.addEventListener('click', () => {
      tabLogin.classList.add('active'); tabSignup.classList.remove('active');
      loginForm.style.display = ''; signupForm.style.display = 'none';
      clearAlerts();
    });
    tabSignup.addEventListener('click', () => {
      tabSignup.classList.add('active'); tabLogin.classList.remove('active');
      signupForm.style.display = ''; loginForm.style.display = 'none';
      clearAlerts();
    });

    // Auto-redirect if already logged in
    onAuthStateChanged(auth, async (user) => {
      if (!user) return;
      try {
        const tokenRes = await getIdTokenResult(user, true);
        if (tokenRes.claims.admin) {
          window.location.href = "admin.html";
        } else {
          window.location.href = "home.html";
        }
      } catch(e) {
        console.warn('Token check failed:', e);
      }
    });

    // Login handler
    loginForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      clearAlerts();
      const email = document.getElementById('loginEmail').value.trim();
      const password = document.getElementById('loginPassword').value;

      const btn = document.getElementById('loginBtn');
      btn.disabled = true; btn.textContent = 'Signing in…';

      try {
        const cred = await signInWithEmailAndPassword(auth, email, password);
        const tokenRes = await getIdTokenResult(cred.user, true);
        showSuccess('Signed in!');
        if (tokenRes.claims.admin) {
          window.location.href = "admin.html";
        } else {
          window.location.href = "home.html";
        }
      } catch (err) {
        showError(err.message);
      } finally {
        btn.disabled = false; btn.textContent = 'Sign in';
      }
    });

    // Password reset
    document.getElementById('forgotPassword').addEventListener('click', async () => {
      clearAlerts();
      const email = prompt('Enter your email for password reset:');
      if (!email) return;
      try {
        await sendPasswordResetEmail(auth, email);
        showSuccess('Password reset email sent. Check your inbox.');
      } catch (err) {
        showError(err.message);
      }
    });

    // Signup handler
    signupForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      clearAlerts();
      const name = document.getElementById('signupName').value.trim();
      const email = document.getElementById('signupEmail').value.trim();
      const pass = document.getElementById('signupPassword').value;
      const pass2 = document.getElementById('signupPassword2').value;

      if (pass !== pass2) {
        showError("Passwords don't match.");
        return;
      }

      const btn = document.getElementById('signupBtn');
      btn.disabled = true; btn.textContent = 'Creating account…';

      try {
        // Create auth user
        const cred = await createUserWithEmailAndPassword(auth, email, pass);
        await updateProfile(cred.user, { displayName: name });

        // Create Firestore teacher doc (ID = uid)
        const uid = cred.user.uid;
        const teacherRef = doc(db, 'teachers', uid);

        try {
          await setDoc(teacherRef, {
            name,
            email,
            route: "",
            vehicle: "",
            accepted: false,
            shiftEnded: false,
            isAdmin: false,
            createdAt: serverTimestamp()
          }, { merge: true });
        } catch (err) {
          // If your rules block create, this will fail. Admin can pre-create instead.
          console.warn('Could not create teacher document (check Firestore rules):', err);
        }

        showSuccess('Account created! Redirecting…');
        // New users won’t have admin claim; go to home
        window.location.href = 'home.html';
      } catch (err) {
        showError(err.message);
      } finally {
        btn.disabled = false; btn.textContent = 'Create account';
      }
    });
  </script>
</body>
</html>

